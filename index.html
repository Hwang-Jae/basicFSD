<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Robot FMS: Final v30 (Fixed & Robust)</title>
    
    <script>
        window.addEventListener('load', function() {
            if (typeof ROSLIB === 'undefined') {
                alert("ğŸš¨ [ì¹˜ëª…ì  ì˜¤ë¥˜] ROS ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!\n\n1. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.\n2. ìƒˆë¡œê³ ì¹¨(F5)ì„ í•´ë³´ì„¸ìš”.\n3. íšŒì‚¬/í•™êµ ë°©í™”ë²½ ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            }
        });
    </script>

    <script src="https://code.createjs.com/1.0.0/easeljs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/eventemitter2@6/lib/eventemitter2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/roslib@1/build/roslib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ros2d@0.9.0/build/ros2d.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #1e1e2f; color: #fff; margin: 0; overflow: hidden; }
        
        /* ë ˆì´ì•„ì›ƒ */
        .main-container { display: flex; height: 100vh; }
        
        .map-section {
            flex: 2; background: #111; position: relative; border-right: 2px solid #444;
            display: flex; justify-content: center; align-items: center;
            background-image: linear-gradient(#222 1px, transparent 1px), linear-gradient(90deg, #222 1px, transparent 1px);
            background-size: 40px 40px;
        }
        #nav-div { box-shadow: 0 0 20px rgba(0, 210, 255, 0.2); }

        .control-section {
            flex: 1; background: #27293d; padding: 20px;
            display: flex; flex-direction: column; gap: 15px; overflow-y: auto; min-width: 350px;
        }

        /* ìŠ¤íƒ€ì¼ ìš”ì†Œ */
        .diag-box { background: #000; border: 1px solid #555; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 0.9rem; text-align: left; }
        .check-item { margin: 5px 0; color: #555; }
        .check-item.ok { color: #00ff00; font-weight: bold; }
        .check-item.fail { color: #ff4444; font-weight: bold; }

        h2 { margin: 0 0 10px 0; color: #00d2ff; }
        .box { background: #333; padding: 15px; border-radius: 10px; margin-bottom: 10px; }
        
        button { border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; transition: 0.1s; }
        button:active { transform: scale(0.95); }
        .btn-conn { background: #007bff; width: 100%; padding: 12px; font-size: 1.1rem; }
        .btn-manual-map { background: #6f42c1; width: 100%; padding: 12px; margin-top:5px; }
        .btn-init { background: #ffc107; color: black; width: 100%; padding: 10px; margin-bottom: 5px; }
        .btn-go { background: #28a745; width: 100%; padding: 10px; }

        .dpad { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; width: 180px; margin: 0 auto; }
        .btn-dir { height: 60px; font-size: 24px; background: #6c757d; border-radius: 8px; }
        .btn-stop { background: #dc3545; }
    </style>
</head>
<body>

<div class="main-container">
    <div class="map-section" id="map-section">
        <div id="nav-div"></div>
        <div style="position: absolute; bottom: 20px; right: 20px; display: flex; gap: 10px;">
            <button onclick="zoomMap(1.1)" style="background:#444; width:40px; height:40px; font-size:20px;">+</button>
            <button onclick="zoomMap(0.9)" style="background:#444; width:40px; height:40px; font-size:20px;">-</button>
            <button onclick="centerOnRobot()" style="background:#17a2b8; height:40px; padding:0 15px;">ğŸ¯ ë¡œë´‡ ì°¾ê¸°</button>
        </div>
        <div style="position: absolute; top: 20px; right: 20px;">
            <button onclick="fitMapToScreen()" style="background:#28a745; padding:8px 15px;">ğŸŒ ì „ì²´ ë³´ê¸°</button>
        </div>
    </div>

    <div class="control-section">
        <h2>ğŸš€ Robot Control (v30)</h2>
        
        <div class="diag-box">
            <div>ğŸ“¡ <b>ì‹œìŠ¤í…œ ìƒíƒœ</b></div>
            <div id="chk-conn" class="check-item">â¬œ ì—°ê²° ëŒ€ê¸° ì¤‘...</div>
            <div id="chk-map" class="check-item">â¬œ ì§€ë„ ëŒ€ê¸° ì¤‘...</div>
        </div>

        <div class="box">
            <label style="color:#ccc; font-size:0.9rem;">ROS ì£¼ì†Œ ì…ë ¥ (í•„ìˆ˜)</label>
            <input type="text" id="ros-master-uri" value="wss://ì—¬ê¸°ì—-ì£¼ì†Œë¥¼-ì…ë ¥í•˜ì„¸ìš”.ngrok-free.app" style="width:100%; padding:8px; box-sizing: border-box; margin-bottom:5px; background:#222; color:#fff; border:1px solid #555;">
            
            <button class="btn-conn" onclick="connect()">ğŸ”Œ ì‹œìŠ¤í…œ ì—°ê²°</button>
            <button class="btn-manual-map" onclick="manualMapLoad()">âš¡ ì§€ë„ ê°•ì œ ë¡œë“œ</button>
        </div>
        
        <div id="console-log" style="font-size:0.8rem; color:#aaa; height:60px; overflow-y:auto; border:1px solid #555; padding:5px; margin-bottom:10px;">
            ë¡œê·¸ ëŒ€ê¸° ì¤‘...
        </div>

        <div class="box" style="text-align: center;">
            <h3>ğŸ•¹ï¸ ìˆ˜ë™ ì¡°ì‘</h3>
            <div class="dpad">
                <div></div><button class="btn-dir" onmousedown="move('forward')">â–²</button><div></div>
                <button class="btn-dir" onmousedown="move('left')">â—€</button>
                <button class="btn-dir btn-stop" onmousedown="move('stop')">â– </button>
                <button class="btn-dir" onmousedown="move('right')">â–¶</button>
                <div></div><button class="btn-dir" onmousedown="move('backward')">â–¼</button><div></div>
            </div>
        </div>

        <div class="box">
            <h3>ğŸ¤– ììœ¨ ì£¼í–‰</h3>
            <button class="btn-init" onclick="setInitialPose()">ğŸ“ ì´ˆê¸° ìœ„ì¹˜ ì„¤ì •</button>
            <div style="display: flex; gap: 5px; margin-top: 5px;">
                <input type="number" id="goal-x" value="1.0" step="0.5" placeholder="X" style="width: 50%; padding: 8px;">
                <input type="number" id="goal-y" value="0.0" step="0.5" placeholder="Y" style="width: 50%; padding: 8px;">
            </div>
            <button class="btn-go" onclick="sendGoal()" style="margin-top:5px;">ğŸš© ëª©í‘œ ì´ë™</button>
        </div>
    </div>
</div>

<script>
    let ros;
    let viewer;
    let robotMarker; 
    let pathShape; 
    let cmdVelTopic;
    let initPoseTopic;
    let goalTopic;
    let robotX = 0; let robotY = 0;
    let mapLoaded = false;
    let currentGrid = null;

    function log(msg) {
        const box = document.getElementById('console-log');
        box.innerHTML = `> ${msg}<br>` + box.innerHTML;
        console.log(msg);
    }

    function check(id, status, text) {
        const el = document.getElementById(id);
        if(status) {
            el.className = 'check-item ok';
            el.innerHTML = `âœ… ${text}`;
        } else {
            el.className = 'check-item fail';
            el.innerHTML = `âŒ ${text}`;
        }
    }

    // [í•µì‹¬ í•¨ìˆ˜] ì—°ê²° ì‹œì‘
    function connect() {
        // 1. ì…ë ¥ì°½ ì°¾ê¸° (ID: ros-master-uri)
        const inputElement = document.getElementById('ros-master-uri');
        
        // ì—ëŸ¬ ë°©ì§€: ì…ë ¥ì°½ì´ ì—†ìœ¼ë©´ ê²½ê³ 
        if (!inputElement) {
            alert("âŒ ì˜¤ë¥˜: ì£¼ì†Œ ì…ë ¥ì°½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì½”ë“œë¥¼ ë‹¤ì‹œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.");
            return;
        }

        const url = inputElement.value.trim();
        
        // ì£¼ì†Œ ìœ íš¨ì„± ê²€ì‚¬
        if (url === "" || url.includes("ì—¬ê¸°ì—-ì£¼ì†Œë¥¼")) {
            alert("âš ï¸ Ngrok ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!\nì˜ˆ: wss://abcd-1234.ngrok-free.app");
            return;
        }

        try { 
            ros = new ROSLIB.Ros({ url : url }); 
        } catch (e) { 
            alert("âŒ ROS ë¼ì´ë¸ŒëŸ¬ë¦¬ ì˜¤ë¥˜:\n" + e); 
            return; 
        }

        ros.on('connection', () => {
            log("âœ… ì—°ê²° ì„±ê³µ!");
            check('chk-conn', true, "ì—°ê²°ë¨ (" + url + ")");
            initViewer();
            initTopics();
            setTimeout(manualMapLoad, 500);
        });
        ros.on('error', (e) => {
            log("âŒ ì—°ê²° ì—ëŸ¬");
            check('chk-conn', false, "ì—°ê²° ì‹¤íŒ¨ (ì£¼ì†Œ í™•ì¸)");
            alert("ì—°ê²° ì‹¤íŒ¨!\n\n1. Ngrok í„°ë¯¸ë„ì´ ì¼œì ¸ ìˆë‚˜ìš”?\n2. ì£¼ì†Œ ì•ì— 'wss://'ë¥¼ ë¶™ì˜€ë‚˜ìš”?\n3. rosbridge_serverê°€ ì¼œì ¸ ìˆë‚˜ìš”?");
        });
        ros.on('close', () => {
            log("âš ï¸ ì—°ê²° ëŠê¹€");
            check('chk-conn', false, "ì—°ê²° ëŠê¹€");
        });
    }

    function initViewer() {
        if(!viewer) {
            const width = document.getElementById('map-section').clientWidth;
            const height = document.getElementById('map-section').clientHeight;
            viewer = new ROS2D.Viewer({ divID : 'nav-div', width : width, height : height });
        }
        if(!pathShape) {
            pathShape = new ROS2D.PathShape({ strokeSize: 0.05, strokeColor: '#ff00ff' }); 
            viewer.scene.addChild(pathShape);
        }
        if(!robotMarker) {
            robotMarker = new ROS2D.NavigationArrow({ size : 0.5, strokeSize : 0.05, fillColor : '#888888', pulse : false });
            robotMarker.visible = true; 
            viewer.scene.addChild(robotMarker);
        }

        let amclPoseTopic = new ROSLIB.Topic({
            ros : ros, name : '/amcl_pose', messageType : 'geometry_msgs/msg/PoseWithCovarianceStamped',
            qos: { reliability: 'reliable', durability: 'transient_local' } 
        });

        amclPoseTopic.subscribe((msg) => {
            robotX = msg.pose.pose.position.x;
            robotY = -msg.pose.pose.position.y;
            robotMarker.x = robotX;
            robotMarker.y = robotY;
            
            let q = msg.pose.pose.orientation;
            let degree = -Math.atan2(2 * (q.w * q.z + q.x * q.y), 1 - 2 * (q.y * q.y + q.z * q.z)) * 180 / Math.PI;
            robotMarker.rotation = degree;
            
            robotMarker.graphics.clear();
            robotMarker.graphics.beginFill("#ff0000").drawPolyStar(0, 0, 0.5, 3, 0.6, -90);
            viewer.scene.update();
        });

        let planTopic = new ROSLIB.Topic({ ros : ros, name : '/plan', messageType : 'nav_msgs/msg/Path' });
        planTopic.subscribe((msg) => {
            pathShape.setPath(msg);
            viewer.scene.update();
        });
    }

    function manualMapLoad() {
        if (!ros || !ros.isConnected) {
            log("âš ï¸ ì—°ê²° ì•ˆ ë¨: ë¨¼ì € ì—°ê²° ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.");
            return;
        }

        if(mapLoaded) return;
        log("ğŸ”„ ì§€ë„ ìš”ì²­ ì¤‘...");

        let mapListener = new ROSLIB.Topic({
            ros : ros, name : '/map', messageType : 'nav_msgs/msg/OccupancyGrid',
            qos: { durability: 'transient_local', reliability: 'reliable' } 
        });

        mapListener.subscribe(function(message) {
            log(`ğŸ‰ ì§€ë„ ë„ì°©! (${message.info.width}x${message.info.height})`);
            try {
                var manualGrid = new ROS2D.OccupancyGrid({ message: message });
                currentGrid = manualGrid;
                viewer.scene.addChildAt(manualGrid, 0); 
                fitMapToScreen();
                mapLoaded = true;
                check('chk-map', true, "ì§€ë„ í‘œì‹œë¨");
                log("ğŸ—ºï¸ ì§€ë„ ë Œë”ë§ ì™„ë£Œ!");
                mapListener.unsubscribe();
            } catch (e) { 
                log("âŒ ì§€ë„ ê·¸ë¦¬ê¸° ì‹¤íŒ¨: " + e);
                check('chk-map', false, "ë Œë”ë§ ì‹¤íŒ¨");
            }
        });
    }

    function fitMapToScreen() {
        if(currentGrid && viewer) {
            viewer.scaleToDimensions(currentGrid.width, currentGrid.height);
            viewer.shift(currentGrid.pose.position.x, currentGrid.pose.position.y);
            viewer.scene.update();
        }
    }

    function initTopics() {
        cmdVelTopic = new ROSLIB.Topic({ ros : ros, name : '/cmd_vel_teleop', messageType : 'geometry_msgs/msg/TwistStamped' });
        initPoseTopic = new ROSLIB.Topic({ ros : ros, name : '/initialpose', messageType : 'geometry_msgs/msg/PoseWithCovarianceStamped' });
        goalTopic = new ROSLIB.Topic({ ros : ros, name : '/goal_pose', messageType : 'geometry_msgs/msg/PoseStamped' });
    }

    function move(direction) {
        if(!cmdVelTopic) return;
        let lx = 0, az = 0;
        let speed = 0.5; let turn = 1.0;
        
        switch(direction) {
            case 'forward': lx = speed; break;
            case 'backward': lx = -speed; break;
            case 'left': az = turn; break;
            case 'right': az = -turn; break;
            case 'stop': lx = 0; az = 0; break;
        }
        let twistStamped = new ROSLIB.Message({
            header: { frame_id: "base_link", stamp: { sec: 0, nanosec: 0 } },
            twist: { linear: { x: lx, y: 0, z: 0 }, angular: { x: 0, y: 0, z: az } }
        });
        cmdVelTopic.publish(twistStamped);
    }

    function centerOnRobot() {
        if(viewer && robotMarker.visible) {
            viewer.shift(robotX, -robotY);
            viewer.scene.update();
        }
    }

    function zoomMap(mul) {
        if(viewer) {
            viewer.scene.scaleX *= mul;
            viewer.scene.scaleY *= mul;
            viewer.scene.update();
        }
    }

    function setInitialPose() {
        if(!initPoseTopic) return;
        let pose = new ROSLIB.Message({
            header: { frame_id: "map" },
            pose: { 
                pose: { position: { x: 0.0, y: 0.0, z: 0.0 }, orientation: { x: 0.0, y: 0.0, z: 0.0, w: 1.0 } },
                covariance: [0.25, 0, 0, 0, 0, 0, 0, 0.25, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.068]
            }
        });
        initPoseTopic.publish(pose);
        log("ğŸ“ ì´ˆê¸°í™” ì „ì†¡");
    }

    function sendGoal() {
        if(!goalTopic) return;
        let x = parseFloat(document.getElementById('goal-x').value);
        let y = parseFloat(document.getElementById('goal-y').value);
        let goalMsg = new ROSLIB.Message({
            header: { frame_id: "map" },
            pose: { position: { x: x, y: y, z: 0.0 }, orientation: { x: 0.0, y: 0.0, z: 0.0, w: 1.0 } }
        });
        goalTopic.publish(goalMsg);
        log(`ğŸš© ì´ë™ ì‹œì‘ (${x}, ${y})`);
    }
</script>

</body>
</html>